name: Build MultiEFI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  prepare-gnu-efi:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: gnu-efi
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install gnu-efi headers/libs
        run: |
          sudo apt update
          sudo apt install -y gnu-efi-dev

      - name: Package gnu-efi for Windows
        run: |
          mkdir -p gnu-efi
          cp -r /usr/include/efi gnu-efi/include
          cp -r /usr/lib/x86_64-linux-gnu/gnu-efi gnu-efi/lib
          tar czf gnu-efi.tar.gz gnu-efi

      - name: Upload gnu-efi artifact
        uses: actions/upload-artifact@v4
        with:
          name: gnu-efi
          path: gnu-efi.tar.gz

  build-windows:
    runs-on: windows-latest
    needs: prepare-gnu-efi
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download gnu-efi artifact
        uses: actions/download-artifact@v4
        with:
          name: gnu-efi
          path: gnu-efi

      - name: Extract gnu-efi
        run: tar -xzf gnu-efi\gnu-efi.tar.gz -C gnu-efi

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils

      - name: Build x86_64 EFI (PE/COFF)
        shell: msys2 {0}
        run: |
          mkdir -p build/x64
          gcc -I gnu-efi/include \
              -I gnu-efi/include/x86_64 \
              -c src/MultiEFI.c \
              -o build/x64/MultiEFI.o \
              -DEFI_FUNCTION_WRAPPER \
              -ffreestanding \
              -fshort-wchar \
              -fno-stack-protector \
              -mno-red-zone \
              -Wall

          gcc -nostdlib -Wl,-entry:efi_main \
              -Wl,--subsystem,10 \
              -o build/x64/bootx64.efi build/x64/MultiEFI.o \
              -L gnu-efi/lib/x86_64 -lgnuefi -lefi

      - name: Build i386 EFI (PE/COFF)
        shell: msys2 {0}
        run: |
          mkdir -p build/i386
          gcc -m32 -I gnu-efi/include \
              -I gnu-efi/include/ia32 \
              -c src/MultiEFI.c \
              -o build/i386/MultiEFI.o \
              -DEFI_FUNCTION_WRAPPER \
              -ffreestanding \
              -fshort-wchar \
              -fno-stack-protector \
              -Wall

          gcc -m32 -nostdlib -Wl,-entry:efi_main \
              -Wl,--subsystem,10 \
              -o build/i386/bootia32.efi build/i386/MultiEFI.o \
              -L gnu-efi/lib/i386 -lgnuefi -lefi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MultiEFI-Binaries
          path: build/
